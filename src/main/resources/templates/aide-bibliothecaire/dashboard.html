<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout/base :: html(title='Aide-Bibliothécaire | SIGTMA', activePage='dashboard', pageTitle='Référentiel & Support')}">

<head></head>

<body>
    <div th:fragment="content">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h3 class="fw-bold mb-1 text-forest">Référentiel & Support</h3>
                <p class="text-muted small mb-0">Bienvenue sur votre espace de gestion des thèses</p>
            </div>
            <div class="d-flex gap-3">
                <span id="connectionStatus"
                    class="badge glass-card border-0 text-dark rounded-pill d-flex align-items-center px-3"
                    style="font-size: 0.8rem; background: rgba(255,255,255,0.5);">
                    <i class="fas fa-circle text-success me-2" style="font-size: 0.6rem;"></i> Connecté
                </span>
                <button class="btn btn-white shadow-sm rounded-pill px-4 border-0" onclick="location.reload()"
                    style="font-size: 0.8rem; background: white;">
                    <i class="fas fa-sync-alt me-2 text-emerald"></i> Actualiser
                </button>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-6 col-xl-3">
                <div class="card border-0 bg-emerald-vibrant text-white p-4 shadow-custom overflow-hidden position-relative h-100"
                    style="border-radius: 2rem;">
                    <div class="position-relative" style="z-index: 2;">
                        <p class="small mb-0 opacity-75 fw-medium">Étudiants Actifs</p>
                        <h2 class="fw-bold mb-0 mt-1" id="statEtudiants">0</h2>
                        <div class="mt-3">
                            <span class="badge bg-white bg-opacity-20 rounded-pill extra-small px-3">Enrolled</span>
                        </div>
                    </div>
                    <i class="fas fa-user-graduate position-absolute end-0 bottom-0 mb-n3 me-n3 opacity-10 fa-6x"
                        style="transform: rotate(-15deg);"></i>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="card border-0 bg-brand-gradient text-white p-4 shadow-custom overflow-hidden position-relative h-100"
                    style="border-radius: 2rem;">
                    <div class="position-relative" style="z-index: 2;">
                        <p class="small mb-0 opacity-75 fw-medium">Encadrants</p>
                        <h2 class="fw-bold mb-0 mt-1" id="statEncadrants">0</h2>
                        <div class="mt-3">
                            <span class="badge bg-white bg-opacity-20 rounded-pill extra-small px-3">Professeurs</span>
                        </div>
                    </div>
                    <i class="fas fa-chalkboard-teacher position-absolute end-0 bottom-0 mb-n3 me-n3 opacity-10 fa-6x"
                        style="transform: rotate(-15deg);"></i>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="card border-0 bg-mint-vibrant text-white p-4 shadow-custom overflow-hidden position-relative h-100"
                    style="border-radius: 2rem;">
                    <div class="position-relative" style="z-index: 2;">
                        <p class="small mb-0 opacity-75 fw-medium">Filières</p>
                        <h2 class="fw-bold mb-0 mt-1" id="statFilieres">0</h2>
                        <div class="mt-3">
                            <span class="badge bg-white bg-opacity-20 rounded-pill extra-small px-3">Académique</span>
                        </div>
                    </div>
                    <i class="fas fa-university position-absolute end-0 bottom-0 mb-n3 me-n3 opacity-10 fa-6x"
                        style="transform: rotate(-15deg);"></i>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="card border-0 bg-forest-gradient text-white p-4 shadow-custom overflow-hidden position-relative h-100"
                    style="border-radius: 2rem;">
                    <div class="position-relative" style="z-index: 2;">
                        <p class="small mb-0 opacity-75 fw-medium">Dépôts du Jour</p>
                        <h2 class="fw-bold mb-0 mt-1" id="statUpdates">0</h2>
                        <div class="mt-3">
                            <span class="badge bg-white bg-opacity-20 rounded-pill extra-small px-3">Aujourd'hui</span>
                        </div>
                    </div>
                    <i class="fas fa-history position-absolute end-0 bottom-0 mb-n3 me-n3 opacity-10 fa-6x"
                        style="transform: rotate(-15deg);"></i>
                </div>
            </div>
        </div>

        <h5 class="fw-bold mb-4 text-forest ms-2">Actions Rapides</h5>
        <div class="action-grid mb-5">
            <div class="action-card" onclick="openDepotModal()">
                <div class="action-icon-box bg-soft-emerald">
                    <i class="fas fa-plus-circle"></i>
                </div>
                <div class="action-title">Nouveau Dépôt</div>
                <div class="action-subtitle">Enregistrer un dossier</div>
            </div>
            <a th:href="@{/aide-bibliothecaire/etudiants}" class="action-card">
                <div class="action-icon-box bg-soft-blue">
                    <i class="fas fa-folder-open"></i>
                </div>
                <div class="action-title">Parcourir</div>
                <div class="action-subtitle">Liste des thèses</div>
            </a>
            <div class="action-card" onclick="refreshDashboard()">
                <div class="action-icon-box bg-soft-indigo">
                    <i class="fas fa-sync"></i>
                </div>
                <div class="action-title">Actualiser</div>
                <div class="action-subtitle">Mise à jour stats</div>
            </div>
            <a th:href="@{/aide-bibliothecaire/etudiants}" class="action-card">
                <div class="action-icon-box bg-soft-purple">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <div class="action-title">Attestations & Rapports</div>
                <div class="action-subtitle">Gérer les documents</div>
            </a>
        </div>

        <div class="row g-4">
            <div class="col-12">
                <div class="card p-4 shadow-sm border-0 rounded-4">
                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3 px-2">
                        <h5 class="fw-bold mb-0 text-forest"><i class="fas fa-bolt text-warning me-3"></i>Inscriptions
                            Récentes</h5>
                        <a th:href="@{/aide-bibliothecaire/etudiants}"
                            class="btn btn-emerald btn-sm rounded-pill px-4">Tout voir</a>
                    </div>
                    <div class="list-group list-group-flush px-2" id="recentInscriptions">
                        <div class="text-center py-5 text-muted">
                            <div class="spinner-border spinner-border-sm text-emerald me-2"></div> Chargement des
                            données...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Nouveau Dépôt -->
        <div class="modal fade" id="modalDepot" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 1.5rem;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-forest">Enregistrer un Nouveau Dossier</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <form id="formDepot">
                            <div class="row g-3">
                                <!-- Section Étudiant -->
                                <div class="col-12">
                                    <h6 class="text-emerald fw-bold border-bottom pb-2">Informations Étudiant</h6>
                                </div>
                                <div class="col-12">
                                    <label class="small fw-medium mb-1">Étudiant</label>
                                    <div class="input-group mb-2">
                                        <input type="text" id="displayEtudiant" class="form-control"
                                            placeholder="Aucun étudiant sélectionné" readonly>
                                        <button class="btn btn-outline-emerald" type="button"
                                            onclick="openSelectEtudiantModal()">
                                            <i class="fas fa-search me-1"></i> Choisir
                                        </button>
                                        <input type="hidden" id="etudiantId" name="etudiantId">
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="checkNewEtudiant"
                                            onchange="toggleNewEtudiant()">
                                        <label class="form-check-label extra-small" for="checkNewEtudiant">
                                            Nouvel étudiant (si non trouvé dans la liste)
                                        </label>
                                    </div>
                                </div>
                                <div id="newEtudiantFields" class="row g-3 m-0 p-0">
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Prénom</label>
                                        <input type="text" name="prenomEtudiant" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Nom</label>
                                        <input type="text" name="nomEtudiant" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Matricule</label>
                                        <input type="text" name="matriculeEtudiant" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Email</label>
                                        <input type="email" name="emailEtudiant" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Filière</label>
                                        <div class="input-group">
                                            <input type="text" id="displayFiliereNew" class="form-control"
                                                placeholder="Choisir..." readonly>
                                            <button class="btn btn-outline-secondary" type="button"
                                                onclick="openSelectFiliereModal('new')">
                                                <i class="fas fa-list"></i>
                                            </button>
                                            <input type="hidden" id="filiereIdNew" name="filiereId">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-medium mb-1">Année Académique</label>
                                        <input type="text" name="anneeAcademique" class="form-control"
                                            placeholder="2024-2025">
                                    </div>
                                </div>

                                <!-- Section Encadrant -->
                                <div class="col-12 mt-4">
                                    <h6 class="text-emerald fw-bold border-bottom pb-2">Informations Encadrant</h6>
                                </div>
                                <div class="col-12">
                                    <label class="small fw-medium mb-1">Encadrant</label>
                                    <div class="input-group mb-2">
                                        <input type="text" id="displayEncadrant" class="form-control"
                                            placeholder="Aucun encadrant sélectionné" readonly>
                                        <button class="btn btn-outline-emerald" type="button"
                                            onclick="openSelectEncadrantModal()">
                                            <i class="fas fa-search me-1"></i> Choisir
                                        </button>
                                        <input type="hidden" id="encadrantId" name="encadrantId">
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="checkNewEncadrant"
                                            onchange="toggleNewEncadrant()">
                                        <label class="form-check-label extra-small" for="checkNewEncadrant">
                                            Nouvel encadrant (si non trouvé)
                                        </label>
                                    </div>
                                </div>
                                <div id="newEncadrantFields" class="row g-3 m-0 p-0">
                                    <div class="col-md-4">
                                        <label class="small fw-medium mb-1">Prénom</label>
                                        <input type="text" name="prenomEncadrant" class="form-control">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-medium mb-1">Nom</label>
                                        <input type="text" name="nomEncadrant" class="form-control">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-medium mb-1">Email</label>
                                        <input type="email" name="emailEncadrant" class="form-control">
                                    </div>
                                    <div class="col-md-12">
                                        <label class="small fw-medium mb-1">Grade</label>
                                        <input type="text" name="gradeEncadrant" class="form-control"
                                            placeholder="Professeur, Docteur...">
                                    </div>
                                </div>

                                <!-- Section Thèse -->
                                <div class="col-12 mt-4">
                                    <h6 class="text-emerald fw-bold border-bottom pb-2">Détails du Travail</h6>
                                </div>
                                <div class="col-12">
                                    <label class="small fw-medium mb-1">Titre</label>
                                    <input type="text" name="titre" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="small fw-medium mb-1">Type</label>
                                    <select name="type" class="form-select" required>
                                        <option value="THESE">Thèse</option>
                                        <option value="MEMOIRE">Mémoire</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="small fw-medium mb-1">Année de Soutenance</label>
                                    <input type="number" name="annee" class="form-control" value="2025" required>
                                </div>
                                <div class="col-12">
                                    <label class="small fw-medium mb-1">Résumé</label>
                                    <textarea name="resume" class="form-control" rows="3"></textarea>
                                </div>
                                <div class="col-12">
                                    <label class="small fw-medium mb-1">Fichier PDF</label>
                                    <input type="file" name="fichierPdf" class="form-control" accept=".pdf" required>
                                </div>
                            </div>
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-light rounded-pill px-4"
                                    data-bs-dismiss="modal">Annuler</button>
                                <button type="submit"
                                    class="btn btn-emerald rounded-pill px-4 shadow-sm text-white">Enregistrer le
                                    Dépôt</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Sélection Étudiant (Pour Dossier) -->
        <div class="modal fade" id="modalSelectEtudiant" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-forest">Choisir un Étudiant</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <input type="text" id="searchInputEtudiant" class="form-control mb-3"
                            placeholder="Rechercher..." oninput="filterTable('tableSelectEtudiant', this.value)">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Prénom</th>
                                        <th>Nom</th>
                                        <th>Matricule</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="tableSelectEtudiantBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Sélection Encadrant (Pour Dossier) -->
        <div class="modal fade" id="modalSelectEncadrant" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-forest">Choisir un Encadrant</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <input type="text" id="searchInputEncadrant" class="form-control mb-3"
                            placeholder="Rechercher..." oninput="filterTable('tableSelectEncadrant', this.value)">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Prénom</th>
                                        <th>Nom</th>
                                        <th>Email</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="tableSelectEncadrantBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Sélection Filière (Pour Dossier) -->
        <div class="modal fade" id="modalSelectFiliere" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-forest">Choisir une Filière</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <input type="text" id="searchInputFiliere" class="form-control mb-3" placeholder="Rechercher..."
                            oninput="filterTable('tableSelectFiliere', this.value)">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="tableSelectFiliereBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <script th:inline="javascript">
            // Etat global pour la sélection de filière (Mode 'new student' dans dossier)
            let currentFiliereTargetId = null;
            let currentFiliereDisplayId = null;

            // --- Logique des Modals de Sélection (Tableaux) ---
            function openSelectEtudiantModal() {
                const modal = new bootstrap.Modal(document.getElementById('modalSelectEtudiant'));
                modal.show();
                loadSelectData('etudiants', 'tableSelectEtudiantBody');
            }

            function openSelectEncadrantModal() {
                const modal = new bootstrap.Modal(document.getElementById('modalSelectEncadrant'));
                modal.show();
                loadSelectData('encadrants', 'tableSelectEncadrantBody');
            }

            function openSelectFiliereModal(targetSuffix) {
                if (targetSuffix === 'new') {
                    currentFiliereTargetId = 'filiereIdNew';
                    currentFiliereDisplayId = 'displayFiliereNew';
                }
                const modal = new bootstrap.Modal(document.getElementById('modalSelectFiliere'));
                modal.show();
                loadSelectData('filieres', 'tableSelectFiliereBody');
            }

            function loadSelectData(type, tbodyId) {
                const tbody = document.getElementById(tbodyId);
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Chargement...</td></tr>';

                fetch('/api/' + type)
                    .then(res => res.json())
                    .then(data => {
                        tbody.innerHTML = '';
                        window['rawData_' + type] = data;
                        renderTable(type, data, tbodyId);
                    });
            }

            function renderTable(type, data, tbodyId) {
                const tbody = document.getElementById(tbodyId);
                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">Aucune donnée</td></tr>';
                    return;
                }

                data.forEach(item => {
                    let row = '';
                    if (type === 'etudiants') {
                        row = `<td>${item.prenom}</td><td>${item.nom}</td><td>${item.matricule}</td>
                               <td><button class="btn btn-sm btn-outline-forest" onclick="selectItem('etudiant', ${item.id}, '${item.prenom} ${item.nom}')">Choisir</button></td>`;
                    } else if (type === 'encadrants') {
                        row = `<td>${item.prenom}</td><td>${item.nom}</td><td>${item.email}</td>
                               <td><button class="btn btn-sm btn-outline-forest" onclick="selectItem('encadrant', ${item.id}, '${item.prenom} ${item.nom}')">Choisir</button></td>`;
                    } else if (type === 'filieres') {
                        row = `<td>${item.nom}</td>
                               <td><button class="btn btn-sm btn-outline-forest" onclick="selectItem('filiere', ${item.id}, '${item.nom}')">Choisir</button></td>`;
                    }
                    tbody.innerHTML += `<tr>${row}</tr>`;
                });
            }

            function filterTable(tableId, query) {
                query = query.toLowerCase();
                const rows = document.querySelectorAll('#' + tableId + 'Body tr');
                rows.forEach(row => {
                    row.style.display = row.innerText.toLowerCase().includes(query) ? '' : 'none';
                });
            }

            function selectItem(type, id, nom) {
                if (type === 'etudiant') {
                    document.getElementById('etudiantId').value = id;
                    document.getElementById('displayEtudiant').value = nom;
                    document.getElementById('checkNewEtudiant').checked = false;
                    toggleNewEtudiant();
                    bootstrap.Modal.getInstance(document.getElementById('modalSelectEtudiant')).hide();
                } else if (type === 'encadrant') {
                    document.getElementById('encadrantId').value = id;
                    document.getElementById('displayEncadrant').value = nom;
                    document.getElementById('checkNewEncadrant').checked = false;
                    toggleNewEncadrant();
                    bootstrap.Modal.getInstance(document.getElementById('modalSelectEncadrant')).hide();
                } else if (type === 'filiere') {
                    if (currentFiliereTargetId) document.getElementById(currentFiliereTargetId).value = id;
                    if (currentFiliereDisplayId) document.getElementById(currentFiliereDisplayId).value = nom;
                    bootstrap.Modal.getInstance(document.getElementById('modalSelectFiliere')).hide();
                }
            }

            // --- Gestion des Modals Principaux ---

            function openDepotModal() {
                const modalEl = document.getElementById('modalDepot');
                if (modalEl) {
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                    // Reset fields for fresh entry
                    document.getElementById('checkNewEtudiant').checked = false; // Default: Select existing
                    toggleNewEtudiant();
                    document.getElementById('checkNewEncadrant').checked = false; // Default: Select existing
                    toggleNewEncadrant();

                    document.getElementById('displayEtudiant').value = '';
                    document.getElementById('displayEncadrant').value = '';
                    document.getElementById('etudiantId').value = '';
                    document.getElementById('encadrantId').value = '';
                }
            }

            function toggleNewEtudiant() {
                const check = document.getElementById('checkNewEtudiant');
                if (!check) return;
                const isNew = check.checked;
                const container = document.getElementById('newEtudiantFields');
                const displayInput = document.getElementById('displayEtudiant');

                if (container) {
                    container.style.display = isNew ? "flex" : "none";
                    const inputs = container.querySelectorAll('input, select');
                    inputs.forEach(i => {
                        if (i.id !== 'displayFiliereNew') i.required = isNew;
                    });
                }
            }

            function toggleNewEncadrant() {
                const check = document.getElementById('checkNewEncadrant');
                if (!check) return;
                const isNew = check.checked;
                const container = document.getElementById('newEncadrantFields');
                if (container) {
                    container.style.display = isNew ? "flex" : "none";
                    const inputs = container.querySelectorAll('input, select');
                    inputs.forEach(i => i.required = isNew);
                }
            }


            // --- Initialisation et Soumission ---

            document.addEventListener('DOMContentLoaded', function () {
                refreshDashboard();
                toggleNewEtudiant();
                toggleNewEncadrant();

                const form = document.getElementById('formDepot');
                if (form) {
                    form.addEventListener('submit', function (e) {
                        e.preventDefault();
                        updateStatus('Enregistrement...', 'warning');

                        const formData = new FormData();
                        const rawData = Object.fromEntries(new FormData(this).entries());

                        // Logic: If checkNewEtudiant is checked, we send explicit fields. 
                        // If not, we rely on etudiantId.
                        // The backend DossierDTO handles both.

                        const dossierObj = {
                            etudiantId: (!document.getElementById('checkNewEtudiant').checked && rawData.etudiantId) ? parseInt(rawData.etudiantId) : null,
                            encadrantId: (!document.getElementById('checkNewEncadrant').checked && rawData.encadrantId) ? parseInt(rawData.encadrantId) : null,
                            titre: rawData.titre,
                            type: rawData.type,
                            annee: parseInt(rawData.annee),
                            resume: rawData.resume,
                            // New fields
                            nomEtudiant: rawData.nomEtudiant,
                            prenomEtudiant: rawData.prenomEtudiant,
                            matriculeEtudiant: rawData.matriculeEtudiant,
                            emailEtudiant: rawData.emailEtudiant,
                            filiereId: rawData.filiereId ? parseInt(rawData.filiereId) : null,
                            anneeAcademique: rawData.anneeAcademique,
                            nomEncadrant: rawData.nomEncadrant,
                            prenomEncadrant: rawData.prenomEncadrant,
                            emailEncadrant: rawData.emailEncadrant,
                            gradeEncadrant: rawData.gradeEncadrant
                        };

                        formData.append('dossier', JSON.stringify(dossierObj));
                        const fileInput = this.querySelector('input[name="fichierPdf"]');
                        if (fileInput.files.length > 0) {
                            formData.append('fichier', fileInput.files[0]);
                        }

                        fetch('/api/theses/depot', {
                            method: 'POST',
                            body: formData
                        })
                            .then(res => {
                                if (res.ok) {
                                    return res.json().then(data => {
                                        if (confirm('Succès ! Dossier déposé. Voulez-vous télécharger l\'attestation de dépôt ?')) {
                                            window.location.href = `/api/theses/${data.id}/attestation`;
                                        }
                                        location.reload();
                                    });
                                } else {
                                    return res.text().then(text => { throw new Error(text || res.statusText) });
                                }
                            })
                            .catch(err => {
                                alert('Erreur : ' + err.message);
                                updateStatus('Connecté', 'success');
                            });
                    });
                }

            });

            function updateStatus(text, color) {
                const el = document.getElementById('connectionStatus');
                if (el) {
                    el.className = `badge bg-${color} rounded-pill d-flex align-items-center px-3 shadow-sm`;
                    el.innerHTML = `<i class="fas fa-circle me-2" style="font-size: 0.5rem;"></i> ${text}`;
                }
            }

            function refreshDashboard() {
                const cacheBust = '?t=' + Date.now();
                fetch('/api/aide/stats/summary' + cacheBust).then(r => r.json()).then(data => {
                    document.getElementById('statEtudiants').innerText = data.totalEtudiants;
                    document.getElementById('statEncadrants').innerText = data.totalEncadrants;
                    document.getElementById('statFilieres').innerText = data.totalFilieres;
                    document.getElementById('statUpdates').innerText = data.todayUpdates;

                    const container = document.getElementById('recentInscriptions');
                    if (container) {
                        container.innerHTML = '';
                        if (!data.recentDeposits || data.recentDeposits.length === 0) {
                            container.innerHTML = '<div class="text-center py-4 text-muted">Aucun dépôt récent.</div>';
                        } else {
                            data.recentDeposits.forEach(d => {
                                const initials = d.nomEtudiant ? d.nomEtudiant.split(' ').map(n => n[0]).join('').toUpperCase() : '??';
                                container.innerHTML += `
                                    <div class="list-group-item px-0 border-0 py-3 d-flex justify-content-between align-items-center transition-hover">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-emerald me-3 shadow-sm">${initials}</div>
                                            <div>
                                                <p class="small fw-bold mb-0 text-forest">${d.nomEtudiant}</p>
                                                <p class="extra-small text-muted mb-0">${d.filiere}</p>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <a href="/api/theses/${d.id}/attestation" class="btn btn-emerald btn-sm rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 28px; height: 28px;" title="Attestation">
                                                <i class="fas fa-stamp" style="font-size: 0.7rem;"></i>
                                            </a>
                                            <span class="badge bg-mint-lightest text-forest extra-small border-mint-soft">${d.date}</span>
                                        </div>
                                    </div>
                                `;
                            });
                        }
                    }
                    updateStatus('Connecté', 'success');
                }).catch(err => {
                    console.error(err);
                    updateStatus('Erreur API', 'danger');
                });
            }

        </script>
    </div>
</body>

</html>