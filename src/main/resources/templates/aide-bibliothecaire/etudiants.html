<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout/base :: html(title='Liste des Dossiers | SIGTMA', activePage='etudiants', pageTitle='Liste des Étudiants & Dossiers')}">

<head></head>

<body>
    <div th:fragment="content">
        <div class="row mb-4 align-items-end">
            <div class="col-md-5">
                <h5 class="fw-bold text-forest">Annuaire des Dossiers</h5>
                <p class="text-muted extra-small mb-0">Recherchez et consultez les thèses et mémoires déposés.</p>
            </div>
            <div class="col-md-7">
                <div class="d-flex gap-2 justify-content-end">
                    <!-- Year Filter -->
                    <div class="input-group shadow-sm" style="width: 150px;">
                        <span class="input-group-text bg-white border-end-0 text-muted px-2"><i
                                class="fas fa-calendar-alt"></i></span>
                        <select id="yearFilter" class="form-select border-start-0 ps-0" onchange="searchDossiers()">
                            <option value="">Année (Toutes)</option>
                        </select>
                    </div>

                    <!-- Type Filter -->
                    <div class="input-group shadow-sm" style="width: 130px;">
                        <span class="input-group-text bg-white border-end-0 text-muted px-2"><i
                                class="fas fa-file-alt"></i></span>
                        <select id="typeFilter" class="form-select border-start-0 ps-0" onchange="searchDossiers()">
                            <option value="">Type (Tous)</option>
                            <option value="THESE">Thèses</option>
                            <option value="MEMOIRE">Mémoires</option>
                        </select>
                    </div>

                    <!-- Date Filter -->
                    <div class="input-group shadow-sm" style="width: 160px;">
                        <span class="input-group-text bg-white border-end-0 text-muted px-2"><i
                                class="far fa-calendar"></i></span>
                        <input type="date" id="dateFilter" class="form-control border-start-0 ps-0"
                            onchange="searchDossiers()">
                    </div>

                    <!-- Search Input -->
                    <div class="input-group shadow-sm" style="width: 250px;">
                        <span class="input-group-text bg-white border-end-0 text-muted ps-2"><i
                                class="fas fa-search"></i></span>
                        <input type="text" id="searchInput" class="form-control border-start-0 ps-0"
                            placeholder="Recherche..." oninput="searchDossiers()">
                    </div>

                    <!-- Print Button -->
                    <button class="btn btn-emerald shadow-sm px-3" onclick="printList()">
                        <i class="fas fa-print"></i>
                    </button>
                    <!-- Export PDF Button -->
                    <button class="btn btn-danger shadow-sm px-3" onclick="exportPDF()"
                        title="Exporter REPERTOIRE (PDF)">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                    <!-- Export CSV Button -->
                    <button class="btn btn-forest shadow-sm px-3" onclick="exportCSV()"
                        title="Exporter en CSV pour rapport">
                        <i class="fas fa-file-csv"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm rounded-4 overflow-hidden" id="printableArea">
            <!-- Header for Print -->
            <div class="d-none d-print-block text-center mb-4" style="visibility: visible !important;">
                <div class="mb-3">
                    <h6 class="fw-bold mb-0" style="color: #1a7a3b; font-size: 14pt;">UNIVERSITE ASSANE SECK DE
                        ZIGUINCHOR</h6>
                    <p class="fw-bold mb-0" style="color: #1a7a3b; font-size: 12pt;">RECTORAT</p>
                    <div style="font-size: 8pt; margin: 5px 0;">*********</div>
                    <p class="fw-bold mb-0" style="font-size: 11pt;">BIBLIOTHEQUE CENTRALE</p>
                    <div style="font-size: 8pt; margin: 5px 0;">*****</div>
                    <p class="extra-small mb-0" style="font-size: 8pt;">BP : 523 - Ziguinchor / Tél : 76 637 88 40</p>
                </div>
                <div class="mb-4">
                    <img src="/images/uasz-logo.png" style="width: 80px;">
                </div>
                <div class="p-3 mb-4" style="background-color: #f1f8f1; border: 2px solid #a5d6a7;">
                    <h5 class="fw-bold text-uppercase mb-0" style="color: #1a7a3b;" id="printReportTitle">Répertoire des
                        dossiers déposés</h5>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="dossiersTable">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4 text-secondary text-uppercase extra-small fw-bold" style="width: 50px;">N°
                            </th>
                            <th class="text-secondary text-uppercase extra-small fw-bold">Date Dépôt</th>
                            <th class="text-secondary text-uppercase extra-small fw-bold">Étudiant</th>
                            <th class="text-secondary text-uppercase extra-small fw-bold">Filière</th>
                            <th class="text-secondary text-uppercase extra-small fw-bold">Titre / Sujet</th>
                            <th class="text-secondary text-uppercase extra-small fw-bold">Encadrant</th>
                            <th class="text-secondary text-uppercase extra-small fw-bold">Statut</th>
                            <th class="text-end pe-4 text-secondary text-uppercase extra-small fw-bold hide-print">
                                Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="8" class="text-center py-5 text-muted">Chargement des données...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Styles pour l'impression -->
        <style>
            @media print {
                body * {
                    visibility: hidden;
                }

                #printableArea,
                #printableArea * {
                    visibility: visible !important;
                }

                #printableArea {
                    position: absolute;
                    left: 0;
                    top: 0;
                    width: 100%;
                    border: none !important;
                    box-shadow: none !important;
                    background: white !important;
                }

                .hide-print {
                    display: none !important;
                }

                .table {
                    border-collapse: collapse !important;
                    width: 100% !important;
                    font-size: 10pt !important;
                }

                .table td,
                .table th {
                    border: 1px solid #000 !important;
                    padding: 6px !important;
                }

                .table thead th {
                    background-color: #f8f9fa !important;
                    color: #000 !important;
                    text-align: center !important;
                }

                /* Badge styling fix for print */
                .badge {
                    border: 1px solid #666;
                    color: #000 !important;
                    background: transparent !important;
                    padding: 2px 8px !important;
                }
            }
        </style>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                populateYearFilter();
                loadDossiers();
            });

            function populateYearFilter() {
                const select = document.getElementById('yearFilter');
                const currentYear = new Date().getFullYear();
                for (let year = currentYear; year >= 2020; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    select.appendChild(option);
                }
            }

            let debounceTimer;
            function searchDossiers() {
                const query = document.getElementById('searchInput').value;
                const date = document.getElementById('dateFilter').value;
                const year = document.getElementById('yearFilter').value;
                const type = document.getElementById('typeFilter').value;

                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    loadDossiers(query, date, year, type);
                }, 300);
            }

            function loadDossiers(query = '', date = '', year = '', type = '') {
                let url = '/api/theses/recherche?';
                const params = new URLSearchParams();
                if (query) params.append('motCle', query);
                if (date) params.append('date', date);
                if (year) params.append('annee', year);
                if (type) params.append('type', type);

                // If no params, default to /api/theses (all) but filtered manually if needed or backend handles empty params?
                // Our backend handles optional params. If both empty, it calls rechercher("", null) -> findAll

                fetch(url + params.toString())
                    .then(res => res.json())
                    .then(data => {
                        const tbody = document.getElementById('tableBody');
                        tbody.innerHTML = '';

                        if (data.length === 0) {
                            tbody.innerHTML = `<tr><td colspan="8" class="text-center py-5 text-muted">Aucun résultat trouvé.</td></tr>`;
                            return;
                        }

                        data.forEach((d, index) => {
                            const etudiantName = d.etudiant ? `${d.etudiant.prenom} ${d.etudiant.nom}` : 'N/A';
                            const matricule = d.etudiant ? d.etudiant.matricule : '';
                            const filiere = (d.etudiant && d.etudiant.filiere) ? d.etudiant.filiere.nom : '-';
                            const encadrantName = d.encadrant ? `${d.encadrant.grade} ${d.encadrant.prenom} ${d.encadrant.nom}` : '-';
                            const dateDepot = d.dateDeDepot || '-';

                            // Badge couleur statut
                            let statusBadge = '';
                            if (d.status === 'VALIDEE') statusBadge = '<span class="badge bg-success-subtle text-success rounded-pill">Validée</span>';
                            else if (d.status === 'REJETEE') statusBadge = '<span class="badge bg-danger-subtle text-danger rounded-pill">Rejetée</span>';
                            else statusBadge = '<span class="badge bg-warning-subtle text-warning rounded-pill">En Attente</span>';

                            // Boutons d'action
                            let actionBtns = `<div class="d-flex justify-content-end gap-2">
                                <a href="/api/theses/${d.id}/attestation" class="btn btn-sm btn-emerald rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 32px; height: 32px;" title="Générer Attestation">
                                    <i class="fas fa-stamp"></i>
                                </a>`;

                            if (d.fichier) {
                                actionBtns += `
                                    <a href="/api/theses/files/${d.fichier}" target="_blank" class="btn btn-sm btn-outline-danger rounded-pill px-2" title="Afficher"><i class="fas fa-eye"></i></a>
                                    <a href="/api/theses/files/${d.fichier}?download=true" class="btn btn-sm btn-danger rounded-pill px-2" title="Télécharger"><i class="fas fa-download"></i></a>`;
                            } else {
                                actionBtns += `<span class="text-muted extra-small align-self-center ms-2">Pas de PDF</span>`;
                            }
                            actionBtns += `</div>`;

                            tbody.innerHTML += `
                                <tr>
                                    <td class="ps-4 text-muted fw-bold extra-small">${index + 1}</td>
                                    <td class="small fw-medium text-dark">${dateDepot}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-mint-lightest text-forest rounded-circle me-3 d-flex align-items-center justify-content-center fw-bold hide-print">
                                                ${etudiantName.charAt(0)}
                                            </div>
                                            <div>
                                                <div class="fw-bold text-dark">${etudiantName}</div>
                                                <div class="extra-small text-muted">${matricule}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td><span class="badge bg-light text-dark border">${filiere}</span></td>
                                    <td style="max-width: 200px;">
                                        <div class="text-truncate fw-medium" title="${d.titre}">${d.titre}</div>
                                        <div class="extra-small text-muted">${d.type} - ${d.annee}</div>
                                    </td>
                                    <td>
                                        <div class="small text-dark">${encadrantName}</div>
                                    </td>
                                    <td>${statusBadge}</td>
                                    <td class="text-end pe-4 hide-print">
                                        ${actionBtns}
                                    </td>
                                </tr>
                            `;
                        });
                    })
                    .catch(err => {
                        document.getElementById('tableBody').innerHTML = `<tr><td colspan="8" class="text-center py-5 text-danger">Erreur de chargement: ${err.message}</td></tr>`;
                    });
            }

            function printList() {
                const year = document.getElementById('yearFilter').value;
                const titleEl = document.getElementById('printReportTitle');
                if (year) {
                    titleEl.innerText = `RÉPERTOIRE DES DÉPÔTS DE L'ANNÉE ${year}`;
                } else {
                    titleEl.innerText = "RÉPERTOIRE GÉNÉRAL DES DOSSIERS DÉPOSÉS";
                }
                window.print();
            }

            function exportCSV() {
                const year = document.getElementById('yearFilter').value;
                if (!year) {
                    alert('Veuillez sélectionner une année pour exporter le rapport annuel.');
                    return;
                }

                if (!confirm(`Voulez-vous vraiment exporter le rapport CSV pour l'année ${year} ?`)) {
                    return;
                }

                // On utilise l'endpoint existant dans RapportStatistiqueController
                // default type "TOUS" or we could ask, but following the "rapport annuel" logic
                window.location.href = `/api/rapports/export?type=TOUS&annee=${year}`;
            }

            function exportPDF() {
                const year = document.getElementById('yearFilter').value;
                const type = document.getElementById('typeFilter').value;

                if (!year) {
                    alert('Veuillez sélectionner une année pour exporter le répertoire PDF.');
                    return;
                }

                if (!type) {
                    alert('Veuillez sélectionner un type (Thèse ou Mémoire) pour exporter le répertoire PDF associé.');
                    return;
                }

                if (!confirm(`Voulez-vous vraiment générer le répertoire PDF pour ${type === 'THESE' ? 'les THÈSES' : 'les MÉMOIRES'} de l'année ${year} ?`)) {
                    return;
                }

                window.location.href = `/api/rapports/export/pdf?type=${type}&annee=${year}`;
            }
        </script>
    </div>
</body>

</html>