<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout/base :: html(title='Dashboard Admin | SIGTMA', activePage='dashboard', pageTitle='Tableau de Bord')}">

<head></head>

<body>
    <div th:fragment="content">
        <!-- Filtres de Période -->
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h3 class="fw-bold mb-1 text-forest">Aperçu Analytique</h3>
                <p class="text-muted small mb-0">Suivi global des activités du système</p>
            </div>
            <div class="glass-card p-1 rounded-pill d-flex gap-1" style="background: rgba(255,255,255,0.6);">
                <button onclick="updateStats('global')"
                    class="btn btn-sm btn-period active px-4 rounded-pill border-0 fw-medium"
                    id="btn-global">Global</button>
                <button onclick="updateStats('annuel')"
                    class="btn btn-sm btn-period px-4 rounded-pill border-0 fw-medium" id="btn-annuel">Année</button>
                <button onclick="updateStats('mensuel')"
                    class="btn btn-sm btn-period px-4 rounded-pill border-0 fw-medium" id="btn-mensuel">Mois</button>
                <button onclick="updateStats('journalier')"
                    class="btn btn-sm btn-period px-4 rounded-pill border-0 fw-medium" id="btn-journalier">Jour</button>
            </div>
            <button class="btn btn-forest rounded-pill px-4 shadow-sm" onclick="openPublishModal()">
                <i class="fas fa-paper-plane me-2"></i>Publier Rapport
            </button>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-6 col-xl-3">
                <div class="card border-0 bg-emerald-vibrant text-white p-4 shadow-custom overflow-hidden position-relative h-100"
                    style="border-radius: 2rem;">
                    <div class="position-relative" style="z-index: 2;">
                        <p class="small mb-0 opacity-75 fw-medium">Total Dépôts</p>
                        <h1 class="fw-bold mb-0 mt-1" id="statTotalTheses"
                            style="font-size: 2.8rem; letter-spacing: -1px;">0</h1>
                        <div class="mt-3">
                            <span class="badge bg-white bg-opacity-20 rounded-pill extra-small px-3">Enregistrés</span>
                        </div>
                    </div>
                    <i class="fas fa-file-alt position-absolute end-0 bottom-0 mb-n3 me-n3 opacity-10 fa-6x"
                        style="transform: rotate(-15deg);"></i>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="card border-0 bg-brand-gradient text-white p-4 shadow-custom overflow-hidden position-relative h-100"
                    style="border-radius: 2rem;">
                    <div class="position-relative" style="z-index: 2;">
                        <p class="small mb-0 opacity-75 fw-medium">Validées</p>
                        <h1 class="fw-bold mb-0 mt-1" id="statValidees"
                            style="font-size: 2.8rem; letter-spacing: -1px;">0</h1>
                        <div class="mt-3">
                            <span class="badge bg-white bg-opacity-20 rounded-pill extra-small px-3">Archivées</span>
                        </div>
                    </div>
                    <i class="fas fa-check-circle position-absolute end-0 bottom-0 mb-n3 me-n3 opacity-10 fa-6x"
                        style="transform: rotate(-15deg);"></i>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="card border-0 bg-mint-vibrant text-white p-4 shadow-custom overflow-hidden position-relative h-100"
                    style="border-radius: 2rem;">
                    <div class="position-relative" style="z-index: 2;">
                        <p class="small mb-0 opacity-75 fw-medium">En Attente</p>
                        <h1 class="fw-bold mb-0 mt-1" id="statEnAttente"
                            style="font-size: 2.8rem; letter-spacing: -1px;">0</h1>
                        <div class="mt-3">
                            <span class="badge bg-white bg-opacity-20 rounded-pill extra-small px-3">À Vérifier</span>
                        </div>
                    </div>
                    <i class="fas fa-clock position-absolute end-0 bottom-0 mb-n3 me-n3 opacity-10 fa-6x"
                        style="transform: rotate(-15deg);"></i>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="card border-0 bg-forest-gradient text-white p-4 shadow-custom overflow-hidden position-relative h-100"
                    style="border-radius: 2rem;">
                    <div class="position-relative" style="z-index: 2;">
                        <p class="small mb-0 opacity-75 fw-medium">Staff UASZ</p>
                        <h1 class="fw-bold mb-0 mt-1" id="statTotalUsers"
                            style="font-size: 2.8rem; letter-spacing: -1px;">0</h1>
                        <div class="mt-3">
                            <span class="badge bg-white bg-opacity-20 rounded-pill extra-small px-3">Actifs</span>
                        </div>
                    </div>
                    <i class="fas fa-users-gear position-absolute end-0 bottom-0 mb-n3 me-n3 opacity-10 fa-6x"
                        style="transform: rotate(-15deg);"></i>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-12">
                <div class="card p-4 shadow-sm border-0">
                    <h5 class="fw-bold mb-4 text-forest">Tendances des Dépôts (Mensuel)</h5>
                    <div style="height: 350px;">
                        <canvas id="chartActivity"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mt-2">
            <div class="col-lg-4">
                <div class="card p-4 h-100 shadow-sm border-0">
                    <h5 class="fw-bold mb-4 text-forest">Répartition par Type</h5>
                    <div style="height: 250px;">
                        <canvas id="chartTypeDist"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card p-4 h-100 shadow-sm border-0">
                    <h5 class="fw-bold mb-4 text-forest">Statut des Dépôts</h5>
                    <div style="height: 250px;">
                        <canvas id="chartStatusDist"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card p-4 h-100 shadow-sm border-0">
                    <h5 class="fw-bold mb-3 text-forest">Trafic par Filière</h5>
                    <div id="filiereStats" class="mt-2">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-emerald opacity-50"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mt-2">
            <div class="col-12">
                <div class="card p-4 shadow-sm border-0 rounded-4">
                    <h5 class="fw-bold mb-4 text-forest">Dépôts par Année (Détails)</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                                <tr class="text-uppercase extra-small fw-bold text-muted border-0">
                                    <th class="border-0">Année</th>
                                    <th class="border-0">Mémoires</th>
                                    <th class="border-0">Thèses</th>
                                    <th class="border-0">Total</th>
                                    <th class="border-0 text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody id="tableYearlyDetail">
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-muted small">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mt-2">
            <div class="col-12">
                <div class="card p-4 shadow-sm border-0 rounded-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0 text-forest">Derniers Dépôts</h5>
                        <a href="/bibliothecaire/catalogue"
                            class="btn btn-emerald-light text-emerald btn-sm rounded-pill px-3">Voir Tout</a>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                                <tr class="text-uppercase extra-small fw-bold text-muted border-0">
                                    <th class="border-0">Titre</th>
                                    <th class="border-0">Étudiant</th>
                                    <th class="border-0">Filière</th>
                                    <th class="border-0">Date</th>
                                    <th class="border-0">Statut</th>
                                </tr>
                            </thead>
                            <tbody id="tableRecentDeposits">
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-muted small">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script th:inline="javascript">
            let activityChart, typeChart, statusChart;

            document.addEventListener('DOMContentLoaded', () => {
                initCharts();
                updateStats('global');
                loadRecentDeposits();
                loadYearlyDetail();
            });

            function initCharts() {
                initActivityChart();
                initDistributionCharts();
            }

            function initActivityChart() {
                const ctx = document.getElementById('chartActivity').getContext('2d');

                fetch('/api/admin/stats/trends')
                    .then(res => res.json())
                    .then(data => {
                        if (activityChart) activityChart.destroy();

                        activityChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.labels,
                                datasets: [
                                    {
                                        label: 'Thèses',
                                        data: data.theses,
                                        borderColor: '#7e22ce',
                                        backgroundColor: 'rgba(126, 34, 206, 0.1)',
                                        fill: true,
                                        tension: 0.4
                                    },
                                    {
                                        label: 'Mémoires',
                                        data: data.memoires,
                                        borderColor: '#0369a1',
                                        backgroundColor: 'rgba(3, 105, 161, 0.1)',
                                        fill: true,
                                        tension: 0.4
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'top' }
                                },
                                scales: {
                                    y: { beginAtZero: true, grid: { color: '#f1f1f1' } },
                                    x: { grid: { display: false } }
                                }
                            }
                        });
                    });
            }

            function initDistributionCharts() {
                // Type Distribution
                const ctxType = document.getElementById('chartTypeDist').getContext('2d');
                fetch('/api/admin/stats/distribution')
                    .then(res => res.json())
                    .then(data => {
                        if (typeChart) typeChart.destroy();
                        typeChart = new Chart(ctxType, {
                            type: 'doughnut',
                            data: {
                                labels: data.map(d => d.type),
                                datasets: [{
                                    data: data.map(d => d.count),
                                    backgroundColor: ['#7e22ce', '#0369a1'],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { position: 'bottom' } },
                                cutout: '70%'
                            }
                        });
                    });
            }

            function updateStatusChart(data) {
                const ctxStatus = document.getElementById('chartStatusDist').getContext('2d');
                if (statusChart) statusChart.destroy();

                statusChart = new Chart(ctxStatus, {
                    type: 'bar',
                    data: {
                        labels: ['Validés', 'En Attente', 'Rejetés'],
                        datasets: [{
                            label: 'Nombre',
                            data: [data.thesesValidees, data.thesesEnAttente, data.thesesRejetees],
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { display: false } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            function updateStats(period) {
                // Update button UI
                document.querySelectorAll('.btn-period').forEach(btn => btn.classList.remove('active'));
                const activeBtn = document.getElementById('btn-' + period);
                if (activeBtn) activeBtn.classList.add('active');

                // Summary Stats
                fetch(`/api/admin/stats/summary?period=${period}`)
                    .then(res => res.json())
                    .then(data => {
                        animateValue("statTotalTheses", 0, data.totalTheses, 1000);
                        animateValue("statValidees", 0, data.thesesValidees, 1000);
                        animateValue("statEnAttente", 0, data.thesesEnAttente, 1000);
                        animateValue("statTotalUsers", 0, data.totalUsers, 1000);

                        updateStatusChart(data);
                    });

                // Filiere distribution (Global only usually, but can be updated)
                loadFiliereStats();
            }

            function animateValue(id, start, end, duration) {
                if (start === end) {
                    document.getElementById(id).innerText = end;
                    return;
                }
                const obj = document.getElementById(id);
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    const value = Math.floor(progress * (end - start) + start);
                    obj.innerText = value.toLocaleString();
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    }
                };
                window.requestAnimationFrame(step);
            }

            function loadFiliereStats() {
                const container = document.getElementById('filiereStats');
                fetch('/api/admin/stats/by-filiere')
                    .then(res => res.json())
                    .then(data => {
                        container.innerHTML = '';
                        if (data.length === 0) {
                            container.innerHTML = '<p class="text-muted small text-center mt-3">Aucune donnée disponible</p>';
                            return;
                        }
                        data.forEach(stat => {
                            container.innerHTML += `
                                <div class="mb-4">
                                    <div class="d-flex justify-content-between mb-1 small text-muted">
                                        <span>${stat.filiere || 'Non défini'}</span>
                                        <span>${stat.percentage}%</span>
                                    </div>
                                    <div class="progress rounded-pill" style="height: 8px;">
                                        <div class="progress-bar bg-emerald" style="width: ${stat.percentage}%;"></div>
                                    </div>
                                </div>
                            `;
                        });
                    });
            }

            function loadRecentDeposits() {
                const tbody = document.getElementById('tableRecentDeposits');
                fetch('/api/theses/recents') // Using existing endpoint if it exists or generic
                    .then(res => res.json())
                    .then(data => {
                        tbody.innerHTML = '';
                        if (data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Aucun dépôt récent</td></tr>';
                            return;
                        }
                        data.forEach(t => {
                            let statusClass = 'bg-warning-soft';
                            let statusText = 'En attente';
                            if (t.status === 'VALIDEE') { statusClass = 'bg-success-soft'; statusText = 'Validé'; }
                            if (t.status === 'REJETEE') { statusClass = 'bg-error-soft'; statusText = 'Rejeté'; }

                            tbody.innerHTML += `
                                <tr>
                                    <td>
                                        <div class="fw-bold text-dark small text-truncate" style="max-width: 250px;">${t.titre}</div>
                                        <div class="extra-small text-muted">${t.type} | ${t.annee}</div>
                                    </td>
                                    <td class="small">${t.etudiant?.prenom} ${t.etudiant?.nom}</td>
                                    <td class="small">${t.etudiant?.filiere?.nom || '-'}</td>
                                    <td class="small">${new Date(t.dateDeDepot).toLocaleDateString()}</td>
                                    <td><span class="badge ${statusClass} extra-small px-3 py-2 rounded-pill">${statusText}</span></td>
                                </tr>
                            `;
                        });
                    });
            }

            function loadYearlyDetail() {
                const tbody = document.getElementById('tableYearlyDetail');
                fetch('/api/admin/stats/yearly-detail')
                    .then(res => res.json())
                    .then(data => {
                        tbody.innerHTML = '';
                        data.forEach(y => {
                            tbody.innerHTML += `
                                <tr>
                                    <td class="fw-bold text-forest fs-5">${y.annee}</td>
                                    <td><span class="badge bg-memoire rounded-pill px-4 fs-6 shadow-sm">${y.memoires.toLocaleString()}</span></td>
                                    <td><span class="badge bg-these rounded-pill px-4 fs-6 shadow-sm">${y.theses.toLocaleString()}</span></td>
                                    <td><span class="badge bg-total rounded-pill px-4 fs-5 fw-bold shadow-sm">${y.total.toLocaleString()}</span></td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-forest rounded-pill px-3" onclick="openPublishModal(${y.annee})">
                                            <i class="fas fa-share-nodes me-1"></i> Partager
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    });
            }

            function openPublishModal(annee) {
                const modal = new bootstrap.Modal(document.getElementById('modalPublish'));
                const url = annee ? `/api/admin/stats/publish-summary?annee=${annee}` : '/api/admin/stats/publish-summary';

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('publishContent').value = data.content;
                        modal.show();
                    });
            }

            function copySummary() {
                const textArea = document.getElementById('publishContent');
                textArea.select();
                document.execCommand('copy');
                alert('Résumé copié dans le presse-papier !');
            }

            function shareEmail() {
                const content = document.getElementById('publishContent').value;
                window.location.href = `mailto:?subject=Rapport de Dépôts&body=${encodeURIComponent(content)}`;
            }

            function shareWhatsApp() {
                const content = document.getElementById('publishContent').value;
                window.open(`https://wa.me/?text=${encodeURIComponent(content)}`, '_blank');
            }
        </script>

        <!-- Modal Publier Rapport -->
        <div class="modal fade" id="modalPublish" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 1.5rem;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-forest">Résumé du Rapport</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4 text-center">
                        <p class="text-muted small mb-4">Ce résumé est prêt à être partagé par email ou sur les réseaux
                            sociaux.</p>
                        <textarea id="publishContent" class="form-control mb-4 border-0 bg-light p-4" rows="12"
                            style="border-radius: 1rem; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; resize: none;"></textarea>

                        <div class="d-flex justify-content-center gap-3">
                            <button class="btn btn-white shadow-sm rounded-pill px-4" onclick="copySummary()">
                                <i class="fas fa-copy me-2 text-primary"></i>Copier
                            </button>
                            <button class="btn btn-white shadow-sm rounded-pill px-4" onclick="shareEmail()">
                                <i class="fas fa-envelope me-2 text-danger"></i>Email
                            </button>
                            <button class="btn btn-white shadow-sm rounded-pill px-4" onclick="shareWhatsApp()">
                                <i class="fab fa-whatsapp me-2 text-success"></i>WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
            .bg-memoire {
                background-color: #e0f2fe;
                color: #0369a1;
                border: 1px solid #bae6fd;
            }

            .bg-these {
                background-color: #f3e8ff;
                color: #7e22ce;
                border: 1px solid #e9d5ff;
            }

            .bg-total {
                background-color: #065f46;
                color: #ffffff;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }

            .btn-period:not(.active):hover {
                background-color: #f8fafc;
            }

            .btn-period.active {
                background-color: var(--primary-emerald) !important;
                color: white !important;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3) !important;
            }

            .bg-warning-soft {
                background-color: #fffbeb !important;
                color: #d97706 !important;
            }

            .bg-primary-soft {
                background-color: #eff6ff !important;
                color: #2563eb !important;
            }
        </style>
    </div>
</body>

</html>