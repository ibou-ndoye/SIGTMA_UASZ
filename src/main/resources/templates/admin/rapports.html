<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout/base :: html(title='Rapports | SIGTMA', activePage='reports', pageTitle='Génération de Rapports')}">

<head></head>

<body>
    <div th:fragment="content">
        <!-- Top Row: Form & Help -->
        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card p-4 shadow-sm border-0 h-100">
                    <h5 class="fw-bold mb-4 text-forest"><i class="fas fa-file-csv me-2"></i> Rapports d'Activités</h5>
                    <p class="text-muted small">Générez une liste complète des dépôts de thèses et mémoires pour une
                        période donnée.</p>

                    <form id="formReport" class="mt-4">
                        <div class="mb-3">
                            <label class="small fw-medium mb-1">Type de Document</label>
                            <select name="type" class="form-select rounded-3">
                                <option value="TOUS">Tous les documents</option>
                                <option value="THESE">Thèses uniquement</option>
                                <option value="MEMOIRE">Mémoires uniquement</option>
                            </select>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <label class="small fw-medium mb-1">Option de Filtrage</label>
                                <select id="filterOption" class="form-select rounded-3 mb-3">
                                    <option value="period">Par Période (Dates)</option>
                                    <option value="year">Par Année Scolaire</option>
                                </select>
                            </div>

                            <!-- Période -->
                            <div id="periodFields" class="row g-3">
                                <div class="col-6">
                                    <label class="small fw-medium mb-1">Du</label>
                                    <input type="date" name="start" class="form-control rounded-3" id="startDate">
                                </div>
                                <div class="col-6">
                                    <label class="small fw-medium mb-1">Au</label>
                                    <input type="date" name="end" class="form-control rounded-3" id="endDate">
                                </div>
                            </div>

                            <!-- Année -->
                            <div id="yearFields" class="col-12 d-none">
                                <label class="small fw-medium mb-1">Année</label>
                                <input type="number" name="annee" class="form-control rounded-3" placeholder="Ex: 2025"
                                    id="yearInput">
                            </div>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <button type="button" id="btnPreview"
                                    class="btn btn-outline-emerald w-100 rounded-pill py-2">
                                    <i class="fas fa-eye me-2"></i> Afficher l'Aperçu
                                </button>
                            </div>
                            <div class="col-6">
                                <button type="submit" class="btn btn-emerald w-100 rounded-pill shadow-sm py-2">
                                    <i class="fas fa-download me-2"></i> Télécharger (CSV)
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card p-4 shadow-sm border-0 h-100 bg-forest text-white">
                    <h5 class="fw-bold mb-4"><i class="fas fa-info-circle me-2"></i> Aide à l'Exportation</h5>
                    <div class="small opacity-75">
                        <p>Les rapports générés contiennent les informations suivantes :</p>
                        <ul>
                            <li>Titre de l'ouvrage</li>
                            <li>Auteur (Étudiant)</li>
                            <li>Encadrant</li>
                            <li>Filière</li>
                            <li>Date de dépôt</li>
                            <li>Statut de validation</li>
                        </ul>
                        <p class="mt-4">Note : Les données sont exportées au format CSV compatible avec Microsoft Excel
                            et Google Sheets.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Row -->
        <div class="row">
            <div id="previewCard" class="col-12 d-none">
                <div class="card p-4 shadow-sm border-0 rounded-4">
                    <h5 class="fw-bold mb-4 text-forest">Aperçu des Données</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle small mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th>Titre</th>
                                    <th>Étudiant</th>
                                    <th>Filière</th>
                                    <th>Année</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody id="tablePreview">
                                <!-- Data will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', () => {
                const filterOption = document.getElementById('filterOption');
                const periodFields = document.getElementById('periodFields');
                const yearFields = document.getElementById('yearFields');

                filterOption.addEventListener('change', (e) => {
                    if (e.target.value === 'year') {
                        periodFields.classList.add('d-none');
                        yearFields.classList.remove('d-none');
                    } else {
                        periodFields.classList.remove('d-none');
                        yearFields.classList.add('d-none');
                    }
                });

                document.getElementById('formReport').addEventListener('submit', function (e) {
                    e.preventDefault();
                    triggerDownload(new FormData(this));
                });

                document.getElementById('btnPreview').addEventListener('click', () => {
                    const formData = new FormData(document.getElementById('formReport'));
                    showPreview(formData);
                });

                function getUrl(formData) {
                    const type = formData.get('type');
                    const option = filterOption.value;
                    let url = `?type=${type}`;

                    if (option === 'year') {
                        const annee = formData.get('annee');
                        if (!annee) { alert('Veuillez saisir une année'); return null; }
                        url += `&annee=${annee}`;
                    } else {
                        const start = formData.get('start');
                        const end = formData.get('end');
                        if (!start || !end) { alert('Veuillez sélectionner les dates'); return null; }
                        url += `&start=${start}&end=${end}`;
                    }
                    return url;
                }

                function triggerDownload(formData) {
                    const params = getUrl(formData);
                    if (params) window.location.href = `/api/rapports/export${params}`;
                }

                function showPreview(formData) {
                    const params = getUrl(formData);
                    if (!params) return;

                    const previewCard = document.getElementById('previewCard');
                    const tbody = document.getElementById('tablePreview');

                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border spinner-border-sm text-emerald"></div> <span class="ms-2">Chargement de l\'aperçu...</span></td></tr>';
                    previewCard.classList.remove('d-none');

                    fetch(`/api/rapports/preview${params}`)
                        .then(async res => {
                            if (!res.ok) {
                                const errText = await res.text();
                                throw new Error(errText || `Erreur ${res.status}`);
                            }
                            return res.json();
                        })
                        .then(data => {
                            tbody.innerHTML = '';
                            if (data.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Aucune donnée trouvée pour ces critères</td></tr>';
                                return;
                            }
                            data.forEach(t => {
                                let statusClass = 'bg-warning-soft';
                                if (t.status === 'VALIDEE') statusClass = 'bg-success-soft';
                                if (t.status === 'REJETEE') statusClass = 'bg-error-soft';

                                tbody.innerHTML += `
                                    <tr>
                                        <td>
                                            <div class="fw-bold text-dark">${t.titre}</div>
                                            <div class="extra-small text-muted">${t.type}</div>
                                        </td>
                                        <td>${t.etudiant?.prenom || '-'} ${t.etudiant?.nom || ''}</td>
                                        <td>${t.etudiant?.filiere?.nom || '-'}</td>
                                        <td class="fw-medium">${t.annee}</td>
                                        <td><span class="badge ${statusClass} extra-small px-2 py-1 rounded-pill">${t.status}</span></td>
                                    </tr>
                                `;
                            });
                        })
                        .catch(err => {
                            tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i> 
                                <strong>Échec du chargement :</strong> ${err.message}
                            </td></tr>`;
                            console.error(err);
                        });
                }
            });
        </script>

        <style>
            .bg-warning-soft {
                background-color: #fffbeb !important;
                color: #d97706 !important;
            }

            .bg-success-soft {
                background-color: #f0fdf4 !important;
                color: #166534 !important;
            }

            .bg-error-soft {
                background-color: #fef2f2 !important;
                color: #991b1b !important;
            }

            .extra-small {
                font-size: 0.75rem;
            }
        </style>
    </div>
</body>

</html>